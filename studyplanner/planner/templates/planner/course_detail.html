{% extends 'planner/base.html' %}
{% block title %}{{ course.name }} | StudyPlanner{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="sp-section-title">{{ course.name }}</h1>
        <div class="sp-muted">{{ course.teacher|default:'Преподаватель не указан' }}</div>
    </div>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary" href="{% url 'course_edit' course.id %}">Edit course</a>
        <a class="btn btn-outline-danger" href="{% url 'course_delete' course.id %}">Delete course</a>
        <a class="btn btn-primary" href="{% url 'task_add' %}?course={{ course.id }}">+ Add task</a>
    </div>
</div>

<div class="sp-card mb-3">
    <div class="d-flex justify-content-between align-items-center">
        <div class="sp-title">Tasks</div>
        <a class="btn btn-outline-secondary btn-sm" href="{% url 'task_list' %}?course={{ course.id }}">View all tasks</a>
    </div>
</div>

<div class="d-grid gap-3">
    {% for task in tasks %}
        <div class="sp-task-card {% if task.deadline and task.deadline < now and task.status != 'DONE' %}sp-overdue-border{% endif %}">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <a class="fw-semibold" href="{% url 'task_detail' task.id %}">{{ task.title }}</a>
                    <div class="sp-muted small">{{ task.course|default:'Без курса' }}</div>
                </div>
                <div class="text-end">
                    {% if task.deadline and task.deadline < now and task.status != 'DONE' %}
                        <span class="sp-badge overdue">OVERDUE</span>
                    {% elif task.status == 'TODO' %}
                        <span class="sp-badge todo">TODO</span>
                    {% elif task.status == 'DOING' %}
                        <span class="sp-badge doing">DOING</span>
                    {% else %}
                        <span class="sp-badge done">DONE</span>
                    {% endif %}
                    {% if task.deadline %}
                        <div class="sp-muted small mt-1">{{ task.deadline|date:'d.m H:i' }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="d-flex justify-content-between flex-wrap">
                <div class="sp-muted small">
                    {{ task.description|default:''|truncatechars:120 }}
                </div>
                <div class="sp-kv">
                    <div class="sp-muted small">{{ task.estimated_minutes }} мин</div>
                    <div class="sp-priority">
                        <span class="{% if task.priority >= 1 %}active{% endif %}"></span>
                        <span class="{% if task.priority >= 2 %}active{% endif %}"></span>
                        <span class="{% if task.priority >= 3 %}active{% endif %}"></span>
                        <span class="{% if task.priority >= 4 %}active{% endif %}"></span>
                        <span class="{% if task.priority >= 5 %}active{% endif %}"></span>
                    </div>
                </div>
            </div>
            <div class="d-flex gap-2 mt-3 align-items-center">
                <a class="btn btn-outline-secondary btn-sm" href="{% url 'task_detail' task.id %}">View</a>
                <a class="btn btn-outline-secondary btn-sm" href="{% url 'task_edit' task.id %}">Edit</a>
                <form method="post" action="{% url 'task_status' task.id %}" class="sp-inline-form">
                    {% csrf_token %}
                    <select class="form-select form-select-sm" name="status" aria-label="Task status">
                        {% for value,label in task.Status.choices %}
                            <option value="{{ value }}" {% if task.status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-outline-secondary btn-sm" type="submit">Save</button>
                </form>
            </div>
        </div>
    {% empty %}
        <div class="sp-card">
            <div class="sp-muted">Задач по курсу нет.</div>
        </div>
    {% endfor %}
</div>
{% endblock %}
